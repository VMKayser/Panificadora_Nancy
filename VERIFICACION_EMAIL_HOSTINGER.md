# üìß Verificaci√≥n de Email con Hostinger

## ‚ùì ¬øQu√© es la verificaci√≥n de email?

La **verificaci√≥n de email** es un proceso donde el usuario debe confirmar su direcci√≥n de correo electr√≥nico haciendo clic en un enlace que se env√≠a a su bandeja de entrada despu√©s del registro.

**Prop√≥sito:**
- ‚úÖ Confirmar que el email existe y es v√°lido
- ‚úÖ Evitar registros con emails falsos
- ‚úÖ Asegurar que el usuario tiene acceso al email proporcionado
- ‚úÖ Reducir spam y cuentas bot

---

## üè¢ Hostinger vs Verificaci√≥n de Email

### ‚ö†Ô∏è **IMPORTANTE: Son servicios DIFERENTES**

#### üì® Hostinger = SMTP (Env√≠o de Emails)
Hostinger te permite:
- ‚úÖ **Enviar emails transaccionales** (confirmaci√≥n de pedidos, notificaciones)
- ‚úÖ Crear direcciones de correo profesionales (`noreply@panificadoranancy.com`)
- ‚úÖ Configurar SMTP para que Laravel env√≠e emails
- ‚úÖ Autenticaci√≥n SPF/DKIM para evitar spam

**Hostinger NO incluye:**
- ‚ùå Sistema de verificaci√≥n de email autom√°tico
- ‚ùå Plantillas de verificaci√≥n listas
- ‚ùå Base de datos para tokens de verificaci√≥n

---

#### üîê Verificaci√≥n de Email = Feature de Laravel
Es una **funcionalidad que debes programar t√∫** en Laravel:
- ‚úÖ Generar token √∫nico de verificaci√≥n
- ‚úÖ Guardar token en base de datos
- ‚úÖ Enviar email con enlace de verificaci√≥n
- ‚úÖ Validar el token cuando el usuario hace clic
- ‚úÖ Marcar la cuenta como verificada

**Usa Hostinger para:**
- ‚úÖ **Enviar** el email de verificaci√≥n
- ‚úÖ Asegurar que llegue a la bandeja (no spam)

---

## üõ†Ô∏è Implementaci√≥n Completa

### Paso 1: Migraci√≥n para Email Verification

```php
// database/migrations/xxxx_add_email_verification_to_users_table.php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->timestamp('email_verified_at')->nullable()->after('email');
            $table->string('verification_token', 64)->nullable()->after('email_verified_at');
        });
    }

    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn(['email_verified_at', 'verification_token']);
        });
    }
};
```

**Ejecutar:**
```bash
cd backend
docker compose exec laravel.test php artisan make:migration add_email_verification_to_users_table
# Copiar el c√≥digo de arriba
docker compose exec laravel.test php artisan migrate
```

---

### Paso 2: Crear Mailable de Verificaci√≥n

```php
// backend/app/Mail/VerificarEmail.php
<?php

namespace App\Mail;

use App\Models\User;
use Illuminate\Bus\Queueable;
use Illuminate\Mail\Mailable;
use Illuminate\Mail\Mailables\Content;
use Illuminate\Mail\Mailables\Envelope;
use Illuminate\Queue\SerializesModels;

class VerificarEmail extends Mailable
{
    use Queueable, SerializesModels;

    public function __construct(public User $user, public string $token)
    {
    }

    public function envelope(): Envelope
    {
        return new Envelope(
            subject: '‚úâÔ∏è Verifica tu Email - Panificadora Nancy',
        );
    }

    public function content(): Content
    {
        return new Content(
            view: 'emails.verificar-email',
            with: [
                'usuario' => $this->user,
                'token' => $this->token,
                'url' => config('app.frontend_url') . '/verificar-email?token=' . $this->token,
            ],
        );
    }
}
```

---

### Paso 3: Plantilla del Email

```blade
{{-- backend/resources/views/emails/verificar-email.blade.php --}}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifica tu Email</title>
</head>
<body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;">
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f5f5f5; padding: 20px;">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    
                    <!-- Header -->
                    <tr>
                        <td style="background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%); padding: 40px 20px; text-align: center;">
                            <h1 style="color: #ffffff; margin: 0; font-size: 28px;">
                                ü•ê Panificadora Nancy
                            </h1>
                        </td>
                    </tr>

                    <!-- Content -->
                    <tr>
                        <td style="padding: 40px 30px;">
                            <h2 style="color: #8B4513; margin-top: 0;">¬°Hola, {{ $usuario->name }}!</h2>
                            
                            <p style="color: #333; line-height: 1.6; font-size: 16px;">
                                Gracias por registrarte en <strong>Panificadora Nancy</strong>. 
                                Para completar tu registro y activar tu cuenta, necesitamos verificar tu direcci√≥n de correo electr√≥nico.
                            </p>

                            <p style="color: #333; line-height: 1.6; font-size: 16px;">
                                Por favor, haz clic en el bot√≥n de abajo:
                            </p>

                            <!-- CTA Button -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin: 30px 0;">
                                <tr>
                                    <td align="center">
                                        <a href="{{ $url }}" 
                                           style="background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%); 
                                                  color: #ffffff; 
                                                  text-decoration: none; 
                                                  padding: 15px 40px; 
                                                  border-radius: 5px; 
                                                  font-weight: bold; 
                                                  font-size: 16px;
                                                  display: inline-block;">
                                            ‚úÖ Verificar mi Email
                                        </a>
                                    </td>
                                </tr>
                            </table>

                            <p style="color: #666; line-height: 1.6; font-size: 14px; border-left: 4px solid #8B4513; padding-left: 15px; margin: 20px 0;">
                                <strong>‚è∞ Este enlace expira en 24 horas.</strong><br>
                                Si no solicitaste este registro, simplemente ignora este correo.
                            </p>

                            <p style="color: #999; line-height: 1.6; font-size: 13px; margin-top: 30px;">
                                Si el bot√≥n no funciona, copia y pega este enlace en tu navegador:<br>
                                <a href="{{ $url }}" style="color: #8B4513; word-break: break-all;">{{ $url }}</a>
                            </p>
                        </td>
                    </tr>

                    <!-- Footer -->
                    <tr>
                        <td style="background-color: #f9f9f9; padding: 20px; text-align: center; border-top: 1px solid #eee;">
                            <p style="color: #666; margin: 5px 0; font-size: 12px;">
                                <strong>Panificadora Nancy</strong>
                            </p>
                            <p style="color: #666; margin: 5px 0; font-size: 12px;">
                                üìç Av. Principal #123, Quillacollo, Cochabamba
                            </p>
                            <p style="color: #666; margin: 5px 0; font-size: 12px;">
                                üìû +591 4-1234567 | üìß info@panificadoranancy.com
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
```

---

### Paso 4: Actualizar AuthController

```php
// backend/app/Http/Controllers/Api/AuthController.php

use App\Mail\VerificarEmail;
use Illuminate\Support\Str;

public function register(Request $request)
{
    // ... validaci√≥n existente ...

    DB::beginTransaction();
    try {
        // Generar token de verificaci√≥n
        $verificationToken = Str::random(64);

        $user = User::create([
            'name' => $validated['name'],
            'email' => $validated['email'],
            'password' => Hash::make($validated['password']),
            'verification_token' => $verificationToken,
            'email_verified_at' => null, // No verificado inicialmente
        ]);

        // Asignar rol...
        $user->assignRole($validated['role'] ?? 'cliente');

        // Crear cliente si es rol cliente...
        if ($user->hasRole('cliente')) {
            Cliente::create([...]);
        }

        // Enviar email de verificaci√≥n
        try {
            Mail::to($user->email)->send(new VerificarEmail($user, $verificationToken));
        } catch (\Exception $e) {
            Log::error('Error enviando email de verificaci√≥n: ' . $e->getMessage());
        }

        DB::commit();

        return response()->json([
            'message' => 'Usuario registrado. Por favor verifica tu email para activar tu cuenta.',
            'user' => $user->load('roles'),
        ], 201);

    } catch (\Exception $e) {
        DB::rollBack();
        throw $e;
    }
}
```

---

### Paso 5: Ruta de Verificaci√≥n

```php
// backend/routes/api.php

Route::get('/verificar-email', [AuthController::class, 'verificarEmail']);
```

---

### Paso 6: M√©todo de Verificaci√≥n en AuthController

```php
// backend/app/Http/Controllers/Api/AuthController.php

public function verificarEmail(Request $request)
{
    $request->validate([
        'token' => 'required|string|size:64',
    ]);

    $user = User::where('verification_token', $request->token)->first();

    if (!$user) {
        return response()->json([
            'message' => 'Token de verificaci√≥n inv√°lido o expirado.'
        ], 400);
    }

    // Verificar si el token tiene m√°s de 24 horas
    if ($user->created_at->diffInHours(now()) > 24) {
        return response()->json([
            'message' => 'El enlace de verificaci√≥n ha expirado. Solicita uno nuevo.'
        ], 400);
    }

    // Marcar como verificado
    $user->update([
        'email_verified_at' => now(),
        'verification_token' => null, // Limpiar el token
    ]);

    return response()->json([
        'message' => '‚úÖ Email verificado exitosamente. Ya puedes iniciar sesi√≥n.',
        'user' => $user
    ], 200);
}
```

---

### Paso 7: Proteger Login (Opcional)

Si quieres que **SOLO usuarios verificados** puedan iniciar sesi√≥n:

```php
// backend/app/Http/Controllers/Api/AuthController.php

public function login(Request $request)
{
    // ... validaci√≥n existente ...

    if (!Auth::attempt($credentials)) {
        return response()->json(['message' => 'Credenciales inv√°lidas'], 401);
    }

    $user = Auth::user();

    // Verificar si el email est√° verificado
    if (is_null($user->email_verified_at)) {
        Auth::logout();
        return response()->json([
            'message' => 'Por favor verifica tu email antes de iniciar sesi√≥n. Revisa tu bandeja de entrada.',
            'email_not_verified' => true
        ], 403);
    }

    $token = $user->createToken('auth-token')->plainTextToken;

    return response()->json([
        'token' => $token,
        'user' => $user->load('roles'),
    ]);
}
```

---

### Paso 8: Frontend - P√°gina de Verificaci√≥n

```jsx
// frontend/src/pages/VerificarEmail.jsx
import React, { useEffect, useState } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { Container, Card, Spinner, Alert } from 'react-bootstrap';
import { CheckCircle, XCircle } from 'lucide-react';
import api from '../services/api';

function VerificarEmail() {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const [estado, setEstado] = useState('verificando'); // verificando, exito, error
  const [mensaje, setMensaje] = useState('');

  useEffect(() => {
    const token = searchParams.get('token');
    
    if (!token) {
      setEstado('error');
      setMensaje('Token de verificaci√≥n no encontrado.');
      return;
    }

    verificarEmail(token);
  }, [searchParams]);

  const verificarEmail = async (token) => {
    try {
      const response = await api.get('/verificar-email', {
        params: { token }
      });
      
      setEstado('exito');
      setMensaje(response.data.message);
      
      // Redirigir al login despu√©s de 3 segundos
      setTimeout(() => {
        navigate('/login');
      }, 3000);
      
    } catch (error) {
      setEstado('error');
      setMensaje(error.response?.data?.message || 'Error al verificar email.');
    }
  };

  return (
    <Container className="py-5">
      <Card className="mx-auto" style={{ maxWidth: '500px' }}>
        <Card.Body className="text-center p-5">
          {estado === 'verificando' && (
            <>
              <Spinner animation="border" variant="primary" className="mb-3" />
              <h4>Verificando tu email...</h4>
              <p className="text-muted">Por favor espera un momento</p>
            </>
          )}

          {estado === 'exito' && (
            <>
              <CheckCircle size={64} className="text-success mb-3" />
              <h4 className="text-success">¬°Email Verificado!</h4>
              <Alert variant="success" className="mt-3">
                {mensaje}
              </Alert>
              <p className="text-muted mt-3">
                Redirigiendo al inicio de sesi√≥n...
              </p>
            </>
          )}

          {estado === 'error' && (
            <>
              <XCircle size={64} className="text-danger mb-3" />
              <h4 className="text-danger">Error de Verificaci√≥n</h4>
              <Alert variant="danger" className="mt-3">
                {mensaje}
              </Alert>
              <button 
                className="btn btn-primary mt-3"
                onClick={() => navigate('/login')}
              >
                Ir al Login
              </button>
            </>
          )}
        </Card.Body>
      </Card>
    </Container>
  );
}

export default VerificarEmail;
```

---

### Paso 9: Agregar Ruta en App.jsx

```jsx
// frontend/src/App.jsx
import VerificarEmail from './pages/VerificarEmail';

// En las rutas:
<Route path="/verificar-email" element={<VerificarEmail />} />
```

---

## üìã Resumen

### ‚úÖ Lo que S√ç hace Hostinger:
1. **Enviar el email** de verificaci√≥n al usuario
2. Proporcionar **credenciales SMTP** para que Laravel env√≠e emails
3. **Autenticaci√≥n** (SPF/DKIM) para evitar spam
4. Email profesional (`noreply@panificadoranancy.com`)

### ‚ùå Lo que NO hace Hostinger:
1. Generar tokens de verificaci√≥n (lo hace Laravel)
2. Validar el token cuando el usuario hace clic (lo hace Laravel)
3. Actualizar la base de datos (lo hace Laravel)
4. Crear la interfaz de verificaci√≥n (lo haces t√∫ en React)

---

## üéØ Diferencia Clave

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  FLUJO COMPLETO                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                     ‚îÇ
‚îÇ  1. Usuario se registra                            ‚îÇ
‚îÇ     ‚Üì                                               ‚îÇ
‚îÇ  2. LARAVEL genera token √∫nico                     ‚îÇ
‚îÇ     ‚Üì                                               ‚îÇ
‚îÇ  3. LARAVEL crea email con enlace                  ‚îÇ
‚îÇ     ‚Üì                                               ‚îÇ
‚îÇ  4. HOSTINGER env√≠a el email                       ‚îÇ ‚Üê Aqu√≠ act√∫a Hostinger
‚îÇ     ‚Üì                                               ‚îÇ
‚îÇ  5. Usuario recibe email en su bandeja             ‚îÇ
‚îÇ     ‚Üì                                               ‚îÇ
‚îÇ  6. Usuario hace clic en el enlace                 ‚îÇ
‚îÇ     ‚Üì                                               ‚îÇ
‚îÇ  7. LARAVEL valida el token                        ‚îÇ
‚îÇ     ‚Üì                                               ‚îÇ
‚îÇ  8. LARAVEL marca cuenta como verificada           ‚îÇ
‚îÇ     ‚Üì                                               ‚îÇ
‚îÇ  9. Usuario puede iniciar sesi√≥n                   ‚îÇ
‚îÇ                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üí° Recomendaci√≥n

**Para Panificadora Nancy:**

‚ùì **¬øNecesitas verificaci√≥n de email?**

- ‚úÖ **SI** tu prioridad es seguridad y prevenir cuentas falsas
- ‚ùå **NO** si quieres facilitar el proceso de registro (menos fricci√≥n)

**Alternativa intermedia:**
- Permitir login sin verificaci√≥n
- Pero **limitar ciertas acciones** hasta verificar:
  - ‚ùå No puede hacer m√°s de 2 pedidos sin verificar
  - ‚ùå No puede acceder a descuentos especiales
  - ‚úÖ Puede navegar y ver productos

---

## üöÄ Configuraci√≥n Hostinger

```env
# .env (Producci√≥n)
MAIL_MAILER=smtp
MAIL_HOST=smtp.hostinger.com
MAIL_PORT=587
MAIL_USERNAME=noreply@panificadoranancy.com
MAIL_PASSWORD=tu_contrase√±a_segura
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="noreply@panificadoranancy.com"
MAIL_FROM_NAME="Panificadora Nancy"

# URL del frontend (para construir el enlace de verificaci√≥n)
FRONTEND_URL=https://panificadoranancy.com
```

---

**Fecha**: 15 de octubre de 2025  
**Estado**: Documentaci√≥n completa de verificaci√≥n de email
